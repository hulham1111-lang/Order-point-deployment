<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«ç™ºæ³¨ç‚¹ç®¡ç†ã‚·ãƒ¼ãƒˆ</title>
    <style>
/* åœ¨åº«ç™ºæ³¨ç‚¹ç®¡ç†ã‚·ãƒ¼ãƒˆ - ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆGASç”¨ã«åŸ‹ã‚è¾¼ã¿ï¼‰ */
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --bg-page: #f0f4f8;
    --card-bg: #ffffff;
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --danger: #dc2626;
    --danger-bg: #fef2f2;
    --success: #16a34a;
    --success-bg: #f0fdf4;
    --warning: #ea580c;
    --warning-bg: #fff7ed;
    --text: #1e293b;
    --text-muted: #64748b;
    --border: #e2e8f0;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
    --radius: 12px;
    --radius-sm: 8px;
}
body {
    font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
    background: var(--bg-page);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
    padding: 24px;
}
.app { max-width: 1200px; margin: 0 auto; }
.page-header { margin-bottom: 28px; }
.page-header h1 { font-size: 1.75rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
.page-header p { color: var(--text-muted); font-size: 0.9rem; }
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}
.summary-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
}
.summary-card .label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
.summary-card .value { font-size: 1.5rem; font-weight: 700; color: var(--text); }
.summary-card.urgent .value { color: var(--danger); }
.summary-card.review .value { color: var(--warning); }
.summary-card.normal .value { color: var(--success); }
.info-section { margin-bottom: 24px; }
.info-box {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    border-left: 4px solid var(--primary);
}
.info-box h3 { font-size: 1rem; font-weight: 600; color: var(--text); margin-bottom: 12px; }
.info-box p { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px; line-height: 1.6; }
.info-box p:last-child { margin-bottom: 0; }
.info-note {
    background: #eff6ff;
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--primary);
    margin-top: 12px !important;
    color: var(--text) !important;
}
.toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
}
.toolbar .search-wrap { flex: 1; min-width: 200px; position: relative; }
.toolbar .search-wrap input {
    width: 100%;
    padding: 10px 36px 10px 36px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.95rem;
    background: var(--card-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 12px center;
}
.toolbar .search-wrap input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}
.search-clear[hidden] { display: none !important; }
.search-clear {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 1.2rem;
    font-weight: 300;
    line-height: 1;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s;
    padding: 0;
}
.search-clear:hover { background: var(--bg-page); color: var(--text); }
.search-clear:active { background: var(--border); }
.filter-tabs {
    display: flex;
    gap: 4px;
    background: var(--card-bg);
    padding: 4px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
}
.filter-tabs button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}
.filter-tabs button:hover { color: var(--text); background: var(--bg-page); }
.filter-tabs button.active { background: var(--primary); color: white; }
.sort-wrap {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--card-bg);
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
}
.sort-label { font-size: 0.85rem; color: var(--text-muted); margin-right: 4px; }
.sort-btn {
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.85rem;
    background: var(--card-bg);
    color: var(--text-muted);
    cursor: pointer;
    transition: background 0.2s, color 0.2s, border-color 0.2s;
}
.sort-btn:hover { color: var(--text); border-color: var(--primary); background: #f8fafc; }
.sort-btn[aria-pressed="true"] { background: var(--primary); color: white; border-color: var(--primary); }
.result-count { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 12px; min-height: 1.4em; }
.table-wrap {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    overflow: hidden;
    margin-bottom: 24px;
}
.table-wrap table { width: 100%; border-collapse: collapse; table-layout: fixed; }
.table-wrap th {
    text-align: left;
    padding: 14px 12px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    background: #f8fafc;
    border-bottom: 1px solid var(--border);
}
.table-wrap th:nth-child(1) { width: 10%; }
.table-wrap th:nth-child(2) { width: 12%; }
.table-wrap th:nth-child(3) { width: 28%; }
.table-wrap th:nth-child(4) { width: 8%; }
.table-wrap th:nth-child(5) { width: 12%; }
.table-wrap th:nth-child(6) { width: 10%; }
.table-wrap th:nth-child(7) { width: 10%; }
.table-wrap th:nth-child(8) { width: 10%; }
.table-wrap td {
    padding: 14px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 0.95rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.table-wrap td:nth-child(3) { white-space: normal; word-break: break-word; max-width: 0; }
.table-wrap tbody tr { transition: background 0.15s; }
.table-wrap tbody tr:hover { background: #f8fafc; }
.table-wrap tbody tr.status-urgent { background: var(--danger-bg); }
.table-wrap tbody tr.status-urgent:hover { background: #fee2e2; }
.table-wrap tbody tr.status-review { background: var(--warning-bg); }
.table-wrap tbody tr.status-review:hover { background: #ffedd5; }
.table-wrap tbody tr.status-ok { background: var(--success-bg); }
.table-wrap tbody tr.status-ok:hover { background: #dcfce7; }
.table-wrap .num { text-align: right; font-variant-numeric: tabular-nums; }
.table-wrap .status {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 9999px;
    font-size: 0.8rem;
    font-weight: 600;
}
.table-wrap .status.urgent { background: var(--danger-bg); color: var(--danger); }
.table-wrap .status.review { background: var(--warning-bg); color: var(--warning); }
.table-wrap .status.ok { background: var(--success-bg); color: var(--success); }
.empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
.app-footer { font-size: 0.85rem; color: var(--text-muted); text-align: center; padding: 16px; }
.app-footer p { margin-bottom: 4px; }
.footer-note { font-size: 0.8rem; opacity: 0.8; }
@media (max-width: 768px) {
    body { padding: 16px; }
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table-wrap table { min-width: 900px; table-layout: auto; }
    .toolbar { flex-direction: column; align-items: stretch; }
    .toolbar .search-wrap { min-width: 100%; }
    .filter-tabs { justify-content: center; }
    .sort-wrap { width: 100%; justify-content: center; }
}
    </style>
</head>
<body>
    <div class="app">
        <header class="page-header">
            <h1>åœ¨åº«ç™ºæ³¨ç‚¹ç®¡ç†ã‚·ãƒ¼ãƒˆ</h1>
            <p>ç¾åœ¨åº«ã¨ç™ºæ³¨ç‚¹ã‚’ç¢ºèªã—ã€ç™ºæ³¨ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æŠŠæ¡ã—ã¾ã™ã€‚</p>
        </header>

        <div class="info-section">
            <div class="info-box">
                <h3>ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h3>
                <p>ã“ã®ç”»é¢ã¯ã€Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œç™ºæ³¨åˆ¤æ–­ã€ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã§ã™ã€‚</p>
                <p class="info-note">ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸Šã§ã€Œâ˜…åœ¨åº«ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ï¼ã€ŒCSVã‹ã‚‰ç™ºæ³¨åˆ¤æ–­ã‚’æ›´æ–°ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        </div>

        <section class="summary-cards">
            <div class="summary-card urgent">
                <div class="label">æ€¥ãç™ºæ³¨</div>
                <div class="value" id="summaryUrgent">0</div>
            </div>
            <div class="summary-card review">
                <div class="label">æ¤œè¨</div>
                <div class="value" id="summaryReview">0</div>
            </div>
            <div class="summary-card">
                <div class="label">ç™»éŒ²å“ç›®æ•°</div>
                <div class="value" id="summaryTotal">0</div>
            </div>
            <div class="summary-card normal">
                <div class="label">ä½™è£•</div>
                <div class="value" id="summaryOk">0</div>
            </div>
        </section>

        <div class="toolbar">
            <div class="search-wrap">
                <input type="text" id="searchInput" placeholder="å•†å“åãƒ»å•†å“ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢" aria-label="æ¤œç´¢" role="searchbox" autocomplete="off">
                <button type="button" class="search-clear" id="searchClear" aria-label="æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢" hidden>Ã—</button>
            </div>
            <div class="filter-tabs" role="tablist">
                <button type="button" role="tab" data-filter="all" class="active">ã™ã¹ã¦</button>
                <button type="button" role="tab" data-filter="urgent">æ€¥ãç™ºæ³¨</button>
                <button type="button" role="tab" data-filter="review">æ¤œè¨</button>
                <button type="button" role="tab" data-filter="ok">ä½™è£•</button>
            </div>
            <div class="sort-wrap">
                <span class="sort-label">ä»•å…¥å…ˆ:</span>
                <button type="button" class="sort-btn" data-sort="asc" id="sortAsc" aria-pressed="true">æ˜‡é †</button>
                <button type="button" class="sort-btn" data-sort="desc" id="sortDesc" aria-pressed="false">é™é †</button>
            </div>
        </div>

        <p class="result-count" id="resultCount" aria-live="polite"></p>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>ä»•å…¥å…ˆ</th>
                        <th>å•†å“ã‚³ãƒ¼ãƒ‰</th>
                        <th>å•†å“å</th>
                        <th class="num">åœ¨åº«æ•°</th>
                        <th class="num">1æ—¥å¹³å‡è²©å£²æ•°</th>
                        <th class="num">åœ¨åº«æœŸé™(æ—¥)</th>
                        <th class="num">ç™ºæ³¨ç›®å®‰(æ•°)</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div class="empty-state" id="emptyState" hidden>
                <p>è©²å½“ã™ã‚‹å“ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
        </div>

        <footer class="app-footer">
            <p>åœ¨åº«ç™ºæ³¨ç‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ç™ºæ³¨åˆ¤æ–­ã‚·ãƒ¼ãƒˆã®è¡¨ç¤ºç”¨ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒª</p>
            <p class="footer-note">ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œç™ºæ³¨åˆ¤æ–­ã€ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã•ã‚Œã¾ã™</p>
        </footer>
    </div>

    <script>
(function() {
    'use strict';

    var items = [];
    var currentFilter = 'all';
    var searchQuery = '';
    var supplierSort = 'asc';

    var tableBody = document.getElementById('tableBody');
    var emptyState = document.getElementById('emptyState');
    var searchInput = document.getElementById('searchInput');
    var searchClear = document.getElementById('searchClear');
    var filterButtons = document.querySelectorAll('.filter-tabs button[data-filter]');
    var summaryUrgent = document.getElementById('summaryUrgent');
    var summaryReview = document.getElementById('summaryReview');
    var summaryTotal = document.getElementById('summaryTotal');
    var summaryOk = document.getElementById('summaryOk');
    var resultCount = document.getElementById('resultCount');

    function getStatus(expiryDays) {
        if (expiryDays === null || expiryDays === undefined || expiryDays === 'å®Ÿç¸¾ãªã—' || expiryDays === 999) {
            return { label: 'å®Ÿç¸¾ãªã—', class: '', emoji: '' };
        }
        var floorDays = Math.floor(expiryDays);
        if (floorDays <= 3) return { label: 'æ€¥ãç™ºæ³¨', class: 'urgent', emoji: 'ğŸ”´' };
        if (floorDays <= 7) return { label: 'æ¤œè¨', class: 'review', emoji: 'ğŸŸ¡' };
        return { label: 'ä½™è£•', class: 'ok', emoji: 'ğŸŸ¢' };
    }

    function getRowClass(status) {
        if (status === 'æ€¥ãç™ºæ³¨') return 'status-urgent';
        if (status === 'æ¤œè¨') return 'status-review';
        if (status === 'ä½™è£•') return 'status-ok';
        return '';
    }

    function normalizeForSearch(str) {
        if (str == null || typeof str !== 'string') return '';
        return str
            .replace(/[\u30FB\u00B7\u2022\u2219ãƒ»]/g, '')
            .replace(/\s+/g, '')
            .toLowerCase()
            .trim();
    }

    function matchesSearch(item) {
        if (!searchQuery.trim()) return true;
        var q = normalizeForSearch(searchQuery);
        if (!q) return true;
        return (item.name && normalizeForSearch(item.name).indexOf(q) !== -1) ||
               (item.code && normalizeForSearch(item.code).indexOf(q) !== -1) ||
               (item.supplier && normalizeForSearch(item.supplier).indexOf(q) !== -1);
    }

    function matchesFilter(item) {
        if (currentFilter === 'all') return true;
        if (currentFilter === 'urgent') return item.status === 'æ€¥ãç™ºæ³¨';
        if (currentFilter === 'review') return item.status === 'æ¤œè¨';
        if (currentFilter === 'ok') return item.status === 'ä½™è£•';
        return true;
    }

    function getFilteredItems() {
        var filtered = items.filter(function(item) {
            return matchesSearch(item) && matchesFilter(item);
        });
        var aVal = function(item) { return (item.supplier || '').toString(); };
        return filtered.slice().sort(function(a, b) {
            var va = aVal(a), vb = aVal(b);
            var cmp = va.localeCompare(vb, 'ja');
            return supplierSort === 'asc' ? cmp : -cmp;
        });
    }

    function formatNumber(value) {
        if (value == null || value === '' || value === 'å®Ÿç¸¾ãªã—' || value === 999) return 'å®Ÿç¸¾ãªã—';
        if (typeof value === 'number') {
            return value % 1 === 0 ? value.toString() : value.toFixed(2);
        }
        return value;
    }

    function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function renderRow(item) {
        var tr = document.createElement('tr');
        var rowClass = getRowClass(item.status);
        if (rowClass) tr.classList.add(rowClass);
        var statusInfo = getStatus(item.expiryDays);
        var statusClass = statusInfo.class;
        var statusLabel = statusInfo.emoji + ' ' + statusInfo.label;
        tr.innerHTML =
            '<td>' + escapeHtml(item.supplier || 'â€”') + '</td>' +
            '<td>' + escapeHtml(item.code || 'â€”') + '</td>' +
            '<td>' + escapeHtml(item.name || 'â€”') + '</td>' +
            '<td class="num">' + formatNumber(item.stock) + '</td>' +
            '<td class="num">' + formatNumber(item.avgSales) + '</td>' +
            '<td class="num">' + formatNumber(item.expiryDays) + '</td>' +
            '<td class="num">' + formatNumber(item.reorderPoint) + '</td>' +
            '<td><span class="status ' + statusClass + '">' + escapeHtml(statusLabel) + '</span></td>';
        return tr;
    }

    function renderTable() {
        var filteredItems = getFilteredItems();
        tableBody.innerHTML = '';
        filteredItems.forEach(function(item) {
            tableBody.appendChild(renderRow(item));
        });
        emptyState.hidden = filteredItems.length > 0;
        if (resultCount) resultCount.textContent = filteredItems.length + 'ä»¶ã®å“ç›®ã‚’è¡¨ç¤º';
    }

    function updateSummary() {
        var urgentCount = items.filter(function(item) { return item.status === 'æ€¥ãç™ºæ³¨'; }).length;
        var reviewCount = items.filter(function(item) { return item.status === 'æ¤œè¨'; }).length;
        var okCount = items.filter(function(item) { return item.status === 'ä½™è£•'; }).length;
        summaryUrgent.textContent = urgentCount;
        summaryReview.textContent = reviewCount;
        summaryOk.textContent = okCount;
        summaryTotal.textContent = items.length;
    }

    function setActiveFilter(filter) {
        currentFilter = filter;
        filterButtons.forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
        });
        renderTable();
    }

    function setSupplierSort(sort) {
        supplierSort = sort;
        var sortAsc = document.getElementById('sortAsc');
        var sortDesc = document.getElementById('sortDesc');
        if (sortAsc) sortAsc.setAttribute('aria-pressed', sort === 'asc' ? 'true' : 'false');
        if (sortDesc) sortDesc.setAttribute('aria-pressed', sort === 'desc' ? 'true' : 'false');
        renderTable();
    }

    function onSearch() {
        searchQuery = searchInput.value;
        if (searchClear) searchClear.hidden = searchQuery.trim() === '';
        renderTable();
    }

    function clearSearch() {
        searchInput.value = '';
        searchQuery = '';
        if (searchClear) searchClear.hidden = true;
        renderTable();
        searchInput.focus();
    }

    function applyData(data) {
        items = data || [];
        items.forEach(function(item) {
            var statusInfo = getStatus(item.expiryDays);
            item.status = statusInfo.label;
        });
        updateSummary();
        renderTable();
    }

    // GAS ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆWeb App ã¨ã—ã¦é–‹ã„ã¦ã„ã‚‹å ´åˆï¼‰
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
            .withSuccessHandler(applyData)
            .withFailureHandler(function(err) {
                console.error(err);
                applyData([]);
            })
            .getOrderJudgmentData();
    } else {
        applyData([]);
    }

    filterButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
            setActiveFilter(btn.getAttribute('data-filter'));
        });
    });
    var sortAsc = document.getElementById('sortAsc');
    var sortDesc = document.getElementById('sortDesc');
    if (sortAsc) sortAsc.addEventListener('click', function() { setSupplierSort('asc'); });
    if (sortDesc) sortDesc.addEventListener('click', function() { setSupplierSort('desc'); });
    searchInput.addEventListener('input', onSearch);
    searchInput.addEventListener('search', onSearch);
    if (searchClear) {
        searchClear.addEventListener('click', clearSearch);
        searchClear.hidden = true; /* åˆæœŸã¯éè¡¨ç¤º */
    }
})();
    </script>
</body>
</html>
