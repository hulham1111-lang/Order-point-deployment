# 在庫発注点管理シート - ウェブアプリ

Googleスプレッドシートの「発注判断」シートのデータを表示するためのウェブアプリです。

## 📋 システム概要

このウェブアプリは、**在庫発注管理システム（プロトタイプ）**の表示用インターフェースです。実際のデータ処理と計算はGoogleスプレッドシート上のGASスクリプトが行い、その結果をこのウェブアプリで見やすく表示します。

## 🗂️ スプレッドシート構成

| シート名 | 役割 | 備考 |
|---------|------|------|
| **CSV取込** | データ入力 | 助ネコのCSVを貼り付ける玄関（1行目の見出しごと貼り付け） |
| **発注判断** | メイン画面 | 全商品の発注優先度を一覧表示（GASが自動で計算結果を書き込む） |
| **履歴** | データベース | 過去90日間の販売実績を記録（GASが自動管理、古いデータは自動削除） |
| **設定** | 基準値管理 | 目標在庫日数やアラート基準を設定（運用に合わせて数字を変更可能） |

## 🔢 計算ロジック

### ① 販売実績の自動算出

GASスクリプトが以下の方法で自動計算します：

- **計算方法**: `前回の在庫数 - 今回の在庫数 = その日の販売数`
- **例外処理**: 在庫が増えている（入庫）場合は「入荷」とみなし、販売数は「0」として記録
- **同日更新**: 1日に複数回更新した場合は、その日の「最新の在庫状況」で上書きし、データ重複を防ぐ

### ② 平均販売数と発注目安

- **1日平均販売数**: `履歴にある同商品コード販売数の合計 ÷ (記録がある日数 - 入荷日の日数)`
  - より正確な一日平均販売数を算出するため、入荷日を分母から除外
  - 2回目のデータ投入時から計算が開始されます

- **在庫期限(日)**: `現在の在庫数 ÷ 1日平均販売数`
  - 実績がない場合は「実績なし」と表示

- **発注目安数**: `(1日平均販売数 × 目標在庫日数) - 現在の在庫数`
  - 目標在庫日数は「設定」シートのB1セルの値を参照

## 📊 ステータスの判定基準

在庫が切れるまでの日数に応じて、自動で色分けされます：

| ステータス | 条件 | 説明 |
|-----------|------|------|
| 🔴 **急ぎ発注** | 在庫期限(日) ≤ リードタイム | 即発注が必要 |
| 🟡 **検討** | リードタイム < 在庫期限(日) ≤ 検討開始日数 | 発注準備を推奨 |
| 🟢 **余裕** | 検討開始日数 < 在庫期限(日) | 直近の発注は不要 |

※リードタイム・検討開始日数は「設定」シートの値を参照します。

## 📋 表示される列

| 列名 | 説明 | 備考 |
|------|------|------|
| 仕入先 | 商品の仕入れ元 | 例：YCC |
| 商品コード | 管理用コード | 助ネコ商品コード |
| 商品名 | 商品の名称 | 「【単品】」プレフィックス付きも可 |
| 在庫数 | 現在の在庫数量 | 数値 |
| 1日平均販売数 | 1日あたりの平均販売数 | 小数点2桁、「実績なし」も可 |
| 在庫期限(日) | 在庫が何日分残っているか | 整数、「実績なし」も可 |
| 発注目安(数) | 発注する際の目安数量 | 数値 |
| ステータス | 発注の優先度 | 🔴急ぎ発注 / 🟡検討 / 🟢余裕 |

## 🚀 使い方

### スプレッドシートでの運用

1. **助ネコから在庫CSVをダウンロード**
   - 「オプション表示」のチェックをすべて入れる

2. **CSV取込シートにインポート**
   - 「CSV取込」シートを選択
   - 「ファイル」＞「インポート」
   - インポート場所：「現在のシートに置換する」
   - 区切り文字の種類：「自動的に検出する」
   - テキストを数値、日付、数式に変換する：✓チェック

3. **GASスクリプトを実行**
   - 上部メニュー「★在庫管理メニュー」＞「CSVから発注判断を更新」をクリック

4. **発注判断シートを確認**
   - 「🔴急ぎ発注」が付いている商品から優先的に発注処理を行う

### ウェブアプリでの表示

このウェブアプリは「発注判断」シートのデータを表示します。

**データ取得方法（実装オプション）:**

1. **Google Apps ScriptのWeb Appとして公開**
   - GASでWeb Appエンドポイントを作成し、JSON形式でデータを返す
   - `script.js` の `loadDataFromSpreadsheet()` 関数を実装

2. **Google Sheets APIを使用**
   - Google Sheets APIを使用して「発注判断」シートから直接データを取得

3. **CSVエクスポート（一時的な方法）**
   - スプレッドシートから「発注判断」シートをCSVとしてエクスポート
   - CSVファイルを読み込む機能を実装（現在はコメントアウト）

## ⚙️ 設定値

「設定」シートで以下の値を管理します：

| セル | 項目 | デフォルト値 | 説明 |
|------|------|------------|------|
| B1 | 目標在庫日数 | 30 | 発注目安数の計算に使用 |
| B2 | リードタイム | 3 | 急ぎ発注の判定基準（日数） |
| B3 | 検討開始日数 | 7 | 検討ステータスの判定基準（日数） |

## 📈 運用スケジュール

| 段階 | 状態 | システムの動き |
|------|------|--------------|
| 初回投入 (Day 1) | 準備中 | 現在の在庫を記録。比較対象がないため発注目安は算出されません |
| 2回目 (Day 2) | 計算開始 | 昨日との差分から「1日分の販売実績」を把握し、発注予測を開始 |
| 安定期 (Day 7〜) | 精度向上 | 1週間分の平均が出るため、精度の高い発注数が算出されます |
| 完成期 (Day 31〜) | フル稼働 | 直近90日間の売れ筋を完全に把握し、最適な在庫管理が可能になります |

## 🛠️ カスタマイズ

- **設定値の変更**: `script.js` の `SETTINGS` オブジェクトを編集（実際の値は「設定」シートから取得することを推奨）
- **デザイン**: `styles.css` の `:root` の色変数を変更
- **レスポンシブ**: モバイル対応済み（横スクロールで全列表示）

## 📝 ファイル構成

- `index.html` - メインHTMLファイル（ローカル／通常サーバ用）
- `styles.css` - スタイルシート
- `script.js` - JavaScript（データ表示・フィルター・検索）
- `script_01.js` - GASスクリプト（スプレッドシート用・計算・メニュー）
- **`GAS用_WebApp.html`** - **GAS デプロイ用**（CSS・JS を1ファイルにまとめたHTML）
- **`GAS用_Code.gs`** - **GAS デプロイ用**（`doGet` と `getOrderJudgmentData`）

---

## ⚠️ スプレッドシートの「デプロイ」で動かない理由

**Google Apps Script の Web アプリは「HTML ファイル1つ」だけを配信します。**

- 通常のウェブサーバでは、`index.html` から `styles.css` や `script.js` を**別ファイル**として読み込めます。
- GAS の Web アプリでは、`doGet()` が返す**1つの HTML の内容だけ**がブラウザに渡されます。
- **`href="styles.css"` や `src="script.js"` は存在しない URL になる**ため、スタイルやスクリプトが読み込まれず、真っ白・レイアウト崩れ・ボタンが動かないなどの不具合になります。

**対応:** CSS と JavaScript を **1つの HTML の中に埋め込んだ** `GAS用_WebApp.html` を使い、GAS ではこの1ファイルだけを「HTML ファイル」として配置してください。

---

## 🚀 GAS で Web アプリとしてデプロイする手順

1. **スプレッドシートで Apps Script を開く**  
   「拡張機能」＞「Apps Script」

2. **既存の計算用スクリプトを残したまま、Web アプリ用のコードを追加**
   - `GAS用_Code.gs` の内容を**コピー**し、Apps Script の **既存の .gs ファイルの末尾に追記**するか、新しい .gs ファイルを作って貼り付ける。
   - 必ず **`doGet`** と **`getOrderJudgmentData`** がプロジェクト内に含まれるようにする。

3. **HTML ファイルを1つだけ作成**
   - 「ファイル」＞「新規」＞「HTML ファイル」
   - 名前を **`Index`** にする（`doGet` の `createHtmlOutputFromFile('Index')` と一致させる）。
   - **`GAS用_WebApp.html`** の**中身をすべて**開いてコピーし、この Index の内容を**全て削除してから**貼り付け、保存。

4. **デプロイ**
   - 「デプロイ」＞「新しいデプロイ」
   - 種類で「ウェブアプリ」を選択。
   - 説明（例：「在庫発注点 Web アプリ」）を入力。
   - 「次のユーザーとして実行」：**自分**
   - 「アクセスできるユーザー」：**全員**（または「組織内」など必要に応じて）
   - 「デプロイ」をクリックし、表示された URL を控える。

5. **動作確認**
   - ブラウザでその URL を開く。
   - 「発注判断」シートにデータがあれば、同じスプレッドシートに紐づいた Web アプリからそのデータが表示されます。

**注意:** HTML の「ファイル名」は `createHtmlOutputFromFile('Index')` の `'Index'` と一致させる必要があります。別名にした場合は、`doGet` 内の `'Index'` も同じ名前に変更してください。

## 🔗 関連ファイル

GASスクリプト（`script_01.js`）は、スプレッドシートの「拡張機能」＞「Apps Script」に貼り付けて使用します。Web アプリ用の `doGet` と `getOrderJudgmentData` は `GAS用_Code.gs` を同じプロジェクトに追加して使います。
